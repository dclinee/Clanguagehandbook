<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-03-13 Mon 14:57 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Volatile Keyword in C/C++</title>
<meta name="author" content="dclinee" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
</head>
<body>
<div id="content" class="content">
<h1 class="title">Volatile Keyword in C/C++</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgad166fd">1. Syntax:</a></li>
<li><a href="#org0d9d003">2. Example:</a></li>
<li><a href="#orgc940221">3. Simple example</a></li>
<li><a href="#orgf575280">4. Real life use of volatile</a></li>
</ul>
</div>
</div>
<p>
Volatile in C/C++ programming language is a keyword which is used with variables to
inform the compiler not to apply any optimizations to code dealing with the variable.
This is used to avoid some assumptions that go into compiler optimizations which
can break the code. This is mainly used in Embedded System programming and real time
systems.
</p>

<div id="outline-container-orgad166fd" class="outline-2">
<h2 id="orgad166fd"><span class="section-number-2">1.</span> Syntax:</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #b9ca4a;">volatile</span> &lt;data_type&gt; &lt;variable_name&gt;;
<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">or</span>
&lt;data_type&gt; <span style="color: #b9ca4a;">volatile</span> &lt;variable_name&gt;;
</pre>
</div>
</div>
</div>

<div id="outline-container-org0d9d003" class="outline-2">
<h2 id="org0d9d003"><span class="section-number-2">2.</span> Example:</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #b9ca4a;">volatile</span> <span style="color: #7aa6da;">int</span> <span style="color: #e7c547;">some_variable</span> = 1;
<span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">or</span>
<span style="color: #7aa6da;">int</span> <span style="color: #b9ca4a;">volatile</span> <span style="color: #e7c547;">other_variable</span> = 100;
</pre>
</div>

<p>
As a general rule, all variables whose value can change suddenly due to an external
reason (like an external device or another program thread) should be declared using
volatile.
</p>

<p>
Note that unnecessarily using volatile for all keywors will reduce performance and
not using it when required will result in unexpected execution result.
</p>

<p>
Compiler optimizations include:
</p>

<p>
. caching variables
. skip checking loop termination conditions or doing it at compile time only
. pre-determining the conditional program path
</p>

<p>
and many more. Volatile is the approach to keep the perfect balance between program
correctness and performance.
</p>
</div>
</div>

<div id="outline-container-orgc940221" class="outline-2">
<h2 id="orgc940221"><span class="section-number-2">3.</span> Simple example</h2>
<div class="outline-text-2" id="text-3">
<p>
To understand the importance of volatile in C/C++, let us consider a simple example
(main.c) as below:
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #c397d8;">#include</span> <span style="color: #eaeaea;">&lt;</span><span style="color: #70c0b1;">stdio.h</span><span style="color: #eaeaea;">&gt;</span>
<span style="color: #c397d8;">#include</span> <span style="color: #70c0b1;">"other_header.h"</span>

<span style="color: #7aa6da;">int</span> <span style="color: #e78c45;">main</span><span style="color: #eaeaea;">(</span><span style="color: #7aa6da;">void</span><span style="color: #eaeaea;">)</span>
  <span style="color: #eaeaea;">{</span>
    <span style="color: #b9ca4a;">while</span><span style="color: #70c0b1;">(</span>some_variable<span style="color: #70c0b1;">)</span>
      <span style="color: #70c0b1;">{}</span>;    <span style="color: #969896; font-style: italic;">// </span><span style="color: #969896; font-style: italic;">infinite loop</span>
  <span style="color: #eaeaea;">}</span>
</pre>
</div>

<p>
We will have a header file other<sub>header.h</sub> as:
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #b9ca4a;">extern</span> <span style="color: #7aa6da;">int</span> <span style="color: #e7c547;">some_variable</span>;
</pre>
</div>

<p>
We will have a common file name test.c to declare some<sub>variable</sub> as:
</p>
<div class="org-src-container">
<pre class="src src-C"><span style="color: #c397d8;">#include</span> <span style="color: #70c0b1;">"other_header.h"</span>
<span style="color: #7aa6da;">int</span> <span style="color: #e7c547;">some_variable</span> = 1;
</pre>
</div>

<p>
Now, if we compile and execute main.c by linking it with test.c, it will fall into
a infinite loop.
</p>

<div class="org-src-container">
<pre class="src src-sh">gcc main.c test.c
./a.out
</pre>
</div>

<p>
This is only because of compiler optimizations.
</p>

<p>
Our compiler(GNU GCC) will think intelligently and see that the value of some<sub>variable</sub>
variable is 1 and will avoid all other checks for the while loop and get into an
infinite loop.
</p>

<p>
The problem is that the value of some<sub>variable</sub> can get changed inbetween and this will
allow the while loop to break but as the compiler has optimized the code to check the value
of some<sub>variable</sub> only once and at the beginning, it will never reach the condition to
get out of the loop.
</p>

<p>
To prevent this, there are two options:
. turn off all compiler optimizations
. turn off compiler optimizations only for required code sections
</p>

<p>
Turning off all compiler optimizations will greatly impact the overall performancw and
hence, the better approach is to turn off optimizations for specific code sections.
</p>

<p>
To solve this, we need to modify test.c as:
</p>

<div class="org-src-container">
<pre class="src src-C"><span style="color: #c397d8;">#include</span> <span style="color: #70c0b1;">"other_header.h"</span>
<span style="color: #b9ca4a;">volatile</span> <span style="color: #7aa6da;">int</span> <span style="color: #e7c547;">some_variable</span> = 1;
</pre>
</div>

<p>
Now, if we execute another thread in parallel to modify the value of some<sub>variable</sub>
variable to 0, the while loop will be stopped.
</p>
</div>
</div>

<div id="outline-container-orgf575280" class="outline-2">
<h2 id="orgf575280"><span class="section-number-2">4.</span> Real life use of volatile</h2>
<div class="outline-text-2" id="text-4">
<p>
Variables should be declared volatile if its value can be changed asynchronously.
Such situations include:
. variables representing device or peripheral registers. Devides can get disconnected
  or damaged anytime.
. variables whose value is changed by a system call like interrupt service routine
. global variabls
. program is not thread sage
. variables which are accessed in multiple threads
</p>

<p>
Note that volatile should not be used as a synchronization method.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="date">Date: 2023-03-10 Fri 00:00</p>
<p class="author">Author: dclinee</p>
<p class="date">Created: 2023-03-13 Mon 14:57</p>
</div>
</body>
</html>
